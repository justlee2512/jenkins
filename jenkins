pipeline {
    agent any

    tools {
        maven 'Maven'  // Tên đã cấu hình trong Global Tool Configuration
        jdk 'JDK'      // Nếu không có, bạn có thể bỏ dòng này
    }

    environment {
        NEXUS_URL = 'my.nexus.address'  // Không cần /repository/... vì plugin sẽ tự ghép
        NEXUS_CREDENTIALS = 'Nexus'     // ID của Jenkins credentials (username/password)
        REPO_NAME = 'maven-releases'    // Tên repository trong Nexus
        GROUP_ID = 'com.blackhat'
        ARTIFACT_ID = 'heart-animation'
        VERSION = '0.0.1'
        FILE_NAME = "target/heart-animation-0.0.1.war"
    }

    stages {
        stage('Checkout Code') {
            steps {
                git credentialsId: 'f90900a0-dd27-4120-a986-56588c9c81c3', url: 'https://github.com/justlee2512/Heart.git', branch: 'master'
            }
        }

        stage('Build with Maven') {
            steps {
                sh 'mvn clean install'
            }
        }

        stage('Deploy to Nexus') {
            steps {
                sh "ls -la target"

                nexusArtifactUploader(
                    nexusVersion: 'nexus3',
                    protocol: 'http',
                    nexusUrl: "${NEXUS_URL}",
                    groupId: "${GROUP_ID}",
                    version: "${VERSION}",
                    repository: "${REPO_NAME}",
                    credentialsId: "${NEXUS_CREDENTIALS}",
                    artifacts: [
                        [
                            artifactId: "${ARTIFACT_ID}",
                            classifier: '',
                            file: "${FILE_NAME}",
                            type: 'war'
                        ]
                    ]
                )
            }
        }

        stage('Archive Artifacts') {
            steps {
                archiveArtifacts artifacts: '**/target/*.war', fingerprint: true
            }
        }
    }

    post {
        success {
            echo 'Build completed successfully and WAR deployed to Nexus!'
        }
        failure {
            echo 'Build failed!'
        }
    }
}
